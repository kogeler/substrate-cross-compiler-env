name: Build Polkadot binaries and images

on:
  workflow_dispatch:
    inputs:
      builds:
        description: "Build profiles from config.yml (all or comma-separated keys)"
        required: false
        default: all
        type: string
  # push:
  #   branches: "*"
  #   paths:
  #     - .github/workflows/polkadot.yml
  #     - dockerfiles/Dockerfile-env-test
  #     - dockerfiles/Dockerfile-env-amd64
  #     - dockerfiles/Dockerfile-amd64
  #     - config.yml
  # pull_request:
  #   paths:
  #     - .github/workflows/polkadot.yml
  #     - dockerfiles/Dockerfile-env-test
  #     - dockerfiles/Dockerfile-env-amd64
  #     - dockerfiles/Dockerfile-amd64
  #     - config.yml

env:
  REGISTRY: ghcr.io
jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Generate matrix from config.yml
        id: set-matrix
        env:
          INPUT_BUILDS: ${{ github.event.inputs.builds || 'all' }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import sys

          import yaml

          with open("config.yml", "r", encoding="utf-8") as file:
              config = yaml.safe_load(file) or {}

          if not isinstance(config, dict) or not config:
              print("::error::config.yml must be a non-empty map of build profiles", file=sys.stderr)
              sys.exit(1)

          selected_builds_raw = (os.environ.get("INPUT_BUILDS") or "all").strip()
          if selected_builds_raw == "all":
              selected_builds = list(config.keys())
          else:
              selected_builds = [build.strip() for build in selected_builds_raw.split(",") if build.strip()]

          if not selected_builds:
              print("::error::No builds selected", file=sys.stderr)
              sys.exit(1)

          unknown_builds = [build for build in selected_builds if build not in config]
          if unknown_builds:
              allowed_builds = ",".join(config.keys())
              print(
                  f"::error::Unknown build(s): {','.join(unknown_builds)}. Allowed values: {allowed_builds}",
                  file=sys.stderr,
              )
              sys.exit(1)

          required_keys = [
              "code_git_repo",
              "code_git_ref",
              "debian-versions",
              "rust-versions",
              "clang-versions",
              "rustc-targets",
              "components",
          ]

          matrix = []
          for build_name in selected_builds:
              item = config[build_name]
              if not isinstance(item, dict):
                  print(f"::error::Build '{build_name}' must be a map", file=sys.stderr)
                  sys.exit(1)

              missing_keys = [key for key in required_keys if key not in item]
              if missing_keys:
                  print(
                      f"::error::Build '{build_name}' is missing keys: {','.join(missing_keys)}",
                      file=sys.stderr,
                  )
                  sys.exit(1)

              for key in ["debian-versions", "rust-versions", "clang-versions", "rustc-targets", "components"]:
                  if not isinstance(item[key], list) or not item[key]:
                      print(
                          f"::error::Build '{build_name}' field '{key}' must be a non-empty list",
                          file=sys.stderr,
                      )
                      sys.exit(1)

              for debian in item["debian-versions"]:
                  for rust in item["rust-versions"]:
                      for clang in item["clang-versions"]:
                          for target in item["rustc-targets"]:
                              for component in item["components"]:
                                  matrix.append(
                                      {
                                          "code_git_repo": item["code_git_repo"],
                                          "code_git_ref": item["code_git_ref"],
                                          "debian-versions": debian,
                                          "rust-versions": rust,
                                          "clang-versions": str(clang),
                                          "rustc-targets": target,
                                          "components": component,
                                      }
                                  )

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as output:
              output.write(f"matrix={json.dumps({'include': matrix}, separators=(',', ':'))}\n")
          PY

  build-binaries:
    runs-on: ubuntu-latest
    needs: [setup-matrix]
    permissions:
      contents: write
      packages: write
    container:
      image: ghcr.io/${{ github.repository_owner }}/substrate-cross-compiler-env:debian-${{ matrix.debian-versions }}-rust-${{ matrix.rust-versions }}-clang-${{ matrix.clang-versions }}
      options: --user 0:0 --privileged -v /var/run/docker.sock:/var/run/docker.sock
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set environmental variables
        run: |
          echo "CODE_GIT_REPO=${{ matrix.code_git_repo }}" >> "$GITHUB_ENV"
          echo "CODE_GIT_REF=${{ matrix.code_git_ref }}" >> "$GITHUB_ENV"
          # Sanitize VERSION for Docker tags/labels: allow only [a-zA-Z0-9._-], replace others with '-'
          VERSION=$(echo "${{ matrix.code_git_ref }}" | sed -E 's/^polkadot-//' | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          BUILD_VERSION="debian-${{ matrix.debian-versions }}-rust-${{ matrix.rust-versions }}-clang-${{ matrix.clang-versions }}-${{ matrix.rustc-targets }}"
          echo "BINARY_FILE_NAME=${{ matrix.components }}-${VERSION}-${BUILD_VERSION}" >> $GITHUB_ENV
          echo "EXECUTE_WORKER_BINARY_FILE_NAME=${{ matrix.components }}-${VERSION}-execute-worker-${BUILD_VERSION}" >> $GITHUB_ENV
          echo "PREPARE_WORKER_BINARY_FILE_NAME=${{ matrix.components }}-${VERSION}-prepare-worker-${BUILD_VERSION}" >> $GITHUB_ENV
          echo "FULL_IMAGE_NAME=${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.components }}:${VERSION}-${BUILD_VERSION}" >> "$GITHUB_ENV"
          git config --global --add safe.directory $(pwd)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.code_git_repo }}
          path: git-content
          ref: ${{ matrix.code_git_ref }}
          fetch-depth: 1
      - name: Build binaries
        working-directory: ./git-content
        env:
          RUSTFLAGS: "-C target-cpu=${{ matrix.rustc-targets }}"
          CFLAGS: "-pipe -fstack-protector-strong -D_FORTIFY_SOURCE=2 -mpclmul -march=${{ matrix.rustc-targets }}"
          CXXFLAGS: "-pipe -fstack-protector-strong -D_FORTIFY_SOURCE=2 -mpclmul -march=${{ matrix.rustc-targets }}"
        run: |
          export WASM_BUILD_WORKSPACE_HINT=$(pwd)
          export BINARIES_DIR=/opt/cargo_target/x86_64-unknown-linux-gnu/production
          env
          mkdir ${GITHUB_WORKSPACE}/artifacts
          echo "Build ${{ matrix.components }}"
          if [ "${{ matrix.components }}" = "polkadot" ]; then
            cargo build --profile production --locked --bin polkadot --bin polkadot-execute-worker --bin polkadot-prepare-worker --target x86_64-unknown-linux-gnu
            ls ${BINARIES_DIR}
            cp ${BINARIES_DIR}/polkadot ${GITHUB_WORKSPACE}/artifacts
            cp ${BINARIES_DIR}/polkadot-execute-worker ${GITHUB_WORKSPACE}/artifacts
            cp ${BINARIES_DIR}/polkadot-prepare-worker ${GITHUB_WORKSPACE}/artifacts
          fi
          if [ "${{ matrix.components }}" = "polkadot-parachain" ]; then
            # "polkadot-parachain" with runtimes is too big for free runers
            export SKIP_WASM_BUILD=1
            cargo build --profile production --locked --bin polkadot-parachain --target x86_64-unknown-linux-gnu
            ls ${BINARIES_DIR}
            cp ${BINARIES_DIR}/polkadot-parachain ${GITHUB_WORKSPACE}/artifacts
          fi
          if [ "${{ matrix.components }}" = "polkadot-omni-node" ]; then
            cargo build --profile production --locked --bin polkadot-omni-node --target x86_64-unknown-linux-gnu
            ls ${BINARIES_DIR}
            cp ${BINARIES_DIR}/polkadot-omni-node ${GITHUB_WORKSPACE}/artifacts
          fi
          if [ "${{ matrix.components }}" = "substrate-node" ]; then
            cargo build --profile production --locked --bin substrate-node --target x86_64-unknown-linux-gnu
            ls ${BINARIES_DIR}
            cp ${BINARIES_DIR}/substrate-node ${GITHUB_WORKSPACE}/artifacts
          fi
      - name: Create GitHub release
        uses: "actions/github-script@v6"
        with:
          script: |
            try {
              const response = await github.rest.repos.createRelease({
                draft: false,
                generate_release_notes: true,
                name: process.env.CODE_GIT_REF,
                owner: context.repo.owner,
                prerelease: false,
                repo: context.repo.repo,
                tag_name: process.env.CODE_GIT_REF,
              });
            } catch (error) {
              core.notice(error.message);
            }
      - name: Upload binaries to GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir gh_artifacts
          echo "Upload ${{ matrix.components }}"
          if [ "${{ matrix.components }}" = "polkadot" ]; then
            cp artifacts/polkadot gh_artifacts/${BINARY_FILE_NAME}
            cp artifacts/polkadot-execute-worker gh_artifacts/${EXECUTE_WORKER_BINARY_FILE_NAME}
            cp artifacts/polkadot-prepare-worker gh_artifacts/${PREPARE_WORKER_BINARY_FILE_NAME}
            gh release upload ${{ env.CODE_GIT_REF }} gh_artifacts/${BINARY_FILE_NAME} --clobber
            gh release upload ${{ env.CODE_GIT_REF }} gh_artifacts/${EXECUTE_WORKER_BINARY_FILE_NAME} --clobber
            gh release upload ${{ env.CODE_GIT_REF }} gh_artifacts/${PREPARE_WORKER_BINARY_FILE_NAME} --clobber
          fi
          if [ "${{ matrix.components }}" = "polkadot-parachain" ]; then
            cp artifacts/polkadot-parachain gh_artifacts/${BINARY_FILE_NAME}
            gh release upload ${{ env.CODE_GIT_REF }} gh_artifacts/${BINARY_FILE_NAME} --clobber
          fi
          if [ "${{ matrix.components }}" = "polkadot-omni-node" ]; then
            cp artifacts/polkadot-omni-node gh_artifacts/${BINARY_FILE_NAME}
            gh release upload ${{ env.CODE_GIT_REF }} gh_artifacts/${BINARY_FILE_NAME} --clobber
          fi
          if [ "${{ matrix.components }}" = "substrate-node" ]; then
            cp artifacts/substrate-node gh_artifacts/${BINARY_FILE_NAME}
            gh release upload ${{ env.CODE_GIT_REF }} gh_artifacts/${BINARY_FILE_NAME} --clobber
          fi
      - name: Log in to container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ github.token }}
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          file: dockerfiles/Dockerfile-amd64
          context: artifacts
          push: true
          load: true
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            DEBIAN_VERSION=${{ matrix.debian-versions }}
            BINARY_NAME=${{ matrix.components }}
          tags: ${{ env.FULL_IMAGE_NAME }}
